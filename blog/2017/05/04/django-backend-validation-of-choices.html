<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Marios Zindilis - Back-end Validation for Django Model Field Choices</title>
  <meta name="description" content="In Django, you can provide a list of values that a field can have whencreating a model. For example, here&#39;s a minimalistic model for storingmusicians:">
  <link
    rel="stylesheet"
    href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css"
    integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M"
    crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="/static/css/zindilis.com.css">
  <link rel="canonical" href="https://zindilis.com/blog/2017/05/04/django-backend-validation-of-choices.html">
  <link rel="alternate" type="application/rss+xml" title="Marios Zindilis" href="https://zindilis.com/feed.xml">
  
  <meta property="og:title" content="Back-end Validation for Django Model Field Choices">


  <meta property="og:type" content="article">

  <meta property="og:article:published_time" content="2017-05-04">


  
    <meta property="og:article:modified_time" content="2017-05-04">
  


  <meta property="og:article:tag" content="django">




</head>


<body>
  <header class="mb-4">
  <nav class="navbar navbar-expand-md navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="/">Marios Zindilis</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-link-items" aria-controls="navbar-link-items" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbar-link-items">
        <div class="navbar-nav ml-auto">
          <a class="nav-item nav-link" style="color:white" href="/docs/">Docs</a>
          <a class="nav-item nav-link" style="color:white" href="/projects/">Projects</a>
          <a class="nav-item nav-link" style="color:white" href="/about/">About</a>
        </div>
      </div>
    </div>
  </nav>
</header>


  <div class="container">
        <article itemscope itemtype="http://schema.org/BlogPosting">

  <header>
    <h1 itemprop="name headline">Back-end Validation for Django Model Field Choices</h1>
    <p class="post-meta">
      <time datetime="2017-05-04T00:00:00+01:00" itemprop="datePublished">2017-05-04</time>
      • <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Marios Zindilis</span></span>
    </p>
  </header>

  <section itemprop="articleBody">
    <p>In Django, you can provide a list of values that a field can have when
creating a model. For example, here&#39;s a minimalistic model for storing
musicians:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>


<span class="k">class</span> <span class="nc">Artist</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>

    <span class="n">TYPE_CHOICES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s">'Person'</span><span class="p">,</span> <span class="s">'Person'</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'Group'</span><span class="p">,</span> <span class="s">'Group'</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'Other'</span><span class="p">,</span> <span class="s">'Other'</span><span class="p">),)</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">TYPE_CHOICES</span><span class="p">)</span>
</code></pre></div>
<p>Using this code in the Admin interface, as well as in Forms, will make the
&quot;Type&quot; field be represented as a drop-down box. Therefore, if all input comes
from Admin and Forms, the value of &quot;Type&quot; is <em>expected</em> to be one of those
defined in the <code>TYPE_CHOICES</code> tuple. There are 2 things worth noting:</p>

<ol>
<li><p>Using <code>choices</code> is a presentation convenience. There is no restriction of
the value that can be sent to the database, even coming from the front-end.
For example, if you use the browser&#39;s <em>inspect</em> feature, you can edit the
drop-down list, change one of the values and submit it. The back-end view
will then happily consume it and save it to the database.</p></li>
<li><p>There is no validation at any stage of the input lifecycle. You may have a
specified list of values in the Admin or Forms front-end, but your
application  may accept input from other sources as well, such as
<a href="https://docs.djangoproject.com/en/1.11/howto/custom-management-commands/" title="Writing custom django-admin commands">management commands</a>, or <a href="https://docs.djangoproject.com/en/1.11/howto/initial-data/" title="Providing initial data for models">bulk imports from fixtures</a>. In none of
those cases will a value that is not in the <code>TYPE_CHOICES</code> structure be
rejected.</p></li>
</ol>

<h2>Validation</h2>

<p>So let&#39;s find a way to fix this by adding some validation in the back-end. </p>

<p>Django has this amazing feature called <a href="https://docs.djangoproject.com/en/1.11/topics/signals/" title="Django Signals">signals</a>. They allow you to attach
extra functionality to some actions, by emitting a signal from that action. For
example, in this case we will use the <code>pre_save</code> signal, which gets executed
just before a model instance is saved to the database.</p>

<p>Here&#39;s the example model, with the signal connected to it:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>


<span class="k">class</span> <span class="nc">Artist</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>

    <span class="n">TYPE_CHOICES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s">'Person'</span><span class="p">,</span> <span class="s">'Person'</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'Group'</span><span class="p">,</span> <span class="s">'Group'</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'Other'</span><span class="p">,</span> <span class="s">'Other'</span><span class="p">),)</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">TYPE_CHOICES</span><span class="p">)</span>


<span class="n">models</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">pre_save</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">validate_artist_name_choice</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">Artist</span><span class="p">)</span>
</code></pre></div>
<p>That last line will call a function named <code>validate_artist_name_choice</code> just
before an Artist is saved in the database. Let&#39;s write that function:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python">
<span class="k">def</span> <span class="nf">validate_artist_name_choice</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">valid_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">sender</span><span class="o">.</span><span class="n">TYPE_CHOICES</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="nb">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_types</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">ValidationError</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
            <span class="s">'Artist Type "{}" is not one of the permitted values: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">instance</span><span class="o">.</span><span class="nb">type</span><span class="p">,</span>
               <span class="s">', '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">valid_types</span><span class="p">)))</span>
</code></pre></div>
<p>This function can be anywhere in your code, as long as you can import it in the
model. Personally, if a <code>pre_save</code> function is specific to one model, I like to
put it in the same module as the model itself, but that&#39;s just my preference.</p>

<p>So let&#39;s try to create a couple of Artists and see what happens. In this
example, my App is called &quot;v&quot;.</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">v.models</span> <span class="kn">import</span> <span class="n">Artist</span>
<span class="o">&gt;&gt;&gt;</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="n">some_artist</span> <span class="o">=</span> <span class="n">Artist</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'Some Artist'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">'Person'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">some_artist</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="n">some_other_artist</span> <span class="o">=</span> <span class="n">Artist</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'Some Other Artist'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">'Alien Lifeform'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">some_other_artist</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s">"/usr/lib/python3.5/code.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">91</span><span class="p">,</span> <span class="ow">in</span> <span class="n">runcode</span>
    <span class="k">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="nb">locals</span><span class="p">)</span>
  <span class="n">File</span> <span class="s">"&lt;console&gt;"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
  <span class="n">File</span> <span class="s">"/home/vs/.local/lib/python3.5/site-packages/django/db/models/base.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">796</span><span class="p">,</span> <span class="ow">in</span> <span class="n">save</span>
    <span class="n">force_update</span><span class="o">=</span><span class="n">force_update</span><span class="p">,</span> <span class="n">update_fields</span><span class="o">=</span><span class="n">update_fields</span><span class="p">)</span>
  <span class="n">File</span> <span class="s">"/home/vs/.local/lib/python3.5/site-packages/django/db/models/base.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">820</span><span class="p">,</span> <span class="ow">in</span> <span class="n">save_base</span>
    <span class="n">update_fields</span><span class="o">=</span><span class="n">update_fields</span><span class="p">)</span>
  <span class="n">File</span> <span class="s">"/home/vs/.local/lib/python3.5/site-packages/django/dispatch/dispatcher.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">191</span><span class="p">,</span> <span class="ow">in</span> <span class="n">send</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">receiver</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">sender</span><span class="p">,</span> <span class="o">**</span><span class="n">named</span><span class="p">)</span>
  <span class="n">File</span> <span class="s">"/home/vs/Tests/validator/v/models.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">14</span><span class="p">,</span> <span class="ow">in</span> <span class="n">validate_artist_name_choice</span>
    <span class="s">', '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">valid_types</span><span class="p">)))</span>
<span class="n">django</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">:</span> <span class="p">[</span><span class="s">'Artist Type "Alien Lifeform" is not one of the permitted values: Person, Group, Other'</span><span class="p">]</span>
</code></pre></div>
<p>Brilliant! We now have a expressive exception that we can catch in our views or
scripts or whatever else we want to use to create model instances. This
exception is thrown either when we call the <code>.save()</code> method of a model
instance, or when we use the <code>.create()</code> method of a model class. Using the
example model, we would get the same exception if we ran:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">Artist</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'Some Other Artist'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">'Alien Lifeform'</span><span class="p">)</span>
</code></pre></div>
<p>Or even:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">Artist</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'Some Other Artist'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">'Alien Lifeform'</span><span class="p">)</span>
</code></pre></div>
<h2>Test It!</h2>

<p>Here&#39;s a test that triggers the exception:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">TestCase</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">ValidationError</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Artist</span>


<span class="k">class</span> <span class="nc">TestArtist</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_artist</span> <span class="o">=</span> <span class="n">Artist</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'Some Artist'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">'Some Type'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_artist_type_choice</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">ValidationError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_artist</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</code></pre></div>
<h2>Conclusion</h2>

<p>Using Django&#39;s <code>pre_save</code> functionality, you can validate your application&#39;s
input in the back-end, and avoid any surprises. Go forth and validate!</p>

  </section>

  <footer id="post-footer">
  
    First Published: <time datetime="2017-05-04T00:00:00+01:00" itemprop="datePublished">2017-05-04</time>
  
  
    &middot; Last modified: <span itemprop="dateModified">2017-05-04</span>
  
  
    &middot; License: <a href="https://creativecommons.org/licenses/by-sa/4.0/" itemprop="license" title="Creative Commons Attribution-ShareAlike 4.0 International">CC-BY-SA-4.0</a>
  
  </footer>

</article>

  </div>

  <footer id="site-footer" class="footer-distributed">
  <div class="container">
    <div class="footer-right">
      <a href="/feed.xml" title="Marios Zindilis RSS Feed">
        <i class="fa fa-rss" aria-hidden="true"></i><span class="sr-only">Marios Zindilis RSS Feed</span></a>
      <a href="https://www.linkedin.com/in/zindilis" title="Marios Zindilis LinkedIn Profile">
        <i class="fa fa-linkedin" aria-hidden="true"></i><span class="sr-only">Marios Zindilis LinkedIn Profile</span></a>
      <a href="https://github.com/marios-zindilis" title="Marios Zindilis GitHub Page">
        <i class="fa fa-github" aria-hidden="true"></i><span class="sr-only">Marios Zindilis GitHub Page</span></a>
    </div>

    <div class="footer-left">
      <p class="footer-links">
        <a href="/">Home</a> · 
        <a href="/docs/">Docs</a> ·
        <a href="/projects/">Projects</a> ·
        <a href="/about/">About</a>
      </p>
      <p>Marios Zindilis</p>
    </div>
  </div>
</footer>

  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>
    <script type="text/javascript">
      // set padding-bottom of body to height of footer.site-footer:
      document.body.style.marginBottom = document.getElementById("site-footer").clientHeight + "px";
      // http://stackoverflow.com/a/14570614
      var observeDOM = (function(){
        var MutationObserver = window.MutationObserver || window.WebKitMutationObserver,
          eventListenerSupported = window.addEventListener;

        return function(obj, callback){
          if( MutationObserver ){
          // define a new observer
            var obs = new MutationObserver(function(mutations, observer){
              if( mutations[0].addedNodes.length || mutations[0].removedNodes.length )
              callback();
            });
            // have the observer observe foo for changes in children
            obs.observe( obj, { childList:true, subtree:true });
          }
          else if( eventListenerSupported ){
            obj.addEventListener('DOMNodeInserted', callback, false);
            obj.addEventListener('DOMNodeRemoved', callback, false);
          }
        }
      })();
      observeDOM(document.getElementById('site-footer') ,function(){
        document.body.style.marginBottom = document.getElementById("site-footer").clientHeight + "px";
      });
    </script>


  </body>
</html>
