<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Marios Zindilis - Regular expressions in python-markdown2 (part 2)</title>
  <meta name="description" content="Study of the regular expressions used in python-markdown2 library">

  <link
    rel="stylesheet"
    href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/css/bootstrap.min.css"
    integrity="sha384-AysaV+vQoT3kOAXZkl02PThvDr8HYKPZhNT5h/CXfBThSRXQ6jW5DO2ekP5ViFdi"
    crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="/static/css/zindilis.com.css">
  <link rel="canonical" href="https://zindilis.com/blog/2015/11/22/regex-in-python-markdown2-pt2.html">
  <link rel="alternate" type="application/rss+xml" title="Marios Zindilis" href="https://zindilis.com/feed.xml">
  
  <meta property="og:title" content="Regular expressions in python-markdown2 (part 2)">


  <meta property="og:type" content="article">

  <meta property="og:article:published_time" content="2015-11-22">


  <meta property="og:article:modified_time" content="2016-05-15">




  <meta property="og:description" content="Study of the regular expressions used in python-markdown2 library">


</head>


<body>
  <header class="site-header">
  <nav class="navbar navbar-fixed-top" style="border-bottom: 1px solid; background-color: white;">
    <div class="container">
      <a class="navbar-brand fload-md-left float-xs-none" href="/">Marios Zindilis</a>
      <ul class="nav navbar-nav float-md-right">
        <li class="nav-item">
          <a class="nav-link" href="/docs/">Docs</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/projects/">Projects</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/about/">About</a>
        </li>
      </ul>
    </div>
  </nav>
</header>


  <div class="container">
        <article itemscope itemtype="http://schema.org/BlogPosting">

  <header>
    <h1 itemprop="name headline">Regular expressions in python-markdown2 (part 2)</h1>
    <p class="post-meta">
      <time datetime="2015-11-22T00:00:00+00:00" itemprop="datePublished">2015-11-22</time>
      • <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Marios Zindilis</span></span>
    </p>
  </header>

  <section itemprop="articleBody">
    <p class="lead">This article is a look into the performance of one of the
regular expressions used in the
<a href="https://github.com/trentm/python-markdown2" title="python-markdown2 on Github"> python-markdown2</a> Python module for
converting Markdown syntax to HTML. It was initially written for pure fun, and
in celebration of its own pointlessness, but eventually the changes proposed
here made it upstream in
<a href="https://github.com/trentm/python-markdown2/pull/207" title="python-markdown2 pull request 207">pull request 207</a>.</p>

<h2 id="replace-tabs-with-spaces">Replace tabs with spaces</h2>

<p>This snippet of code replaces tab characters with a predefined number of 
spaces. It is a Python port of the Perl code mentioned by 
<a href="http://search.cpan.org/~bartl/" title="Bart Lateur">Bart Lateur</a> in a post about 
<a href="http://www.nntp.perl.org/group/perl.macperl.anyperl/2002/03/msg154.html" title="Perl Tabs to Spaces">turning tabs to spaces in Perl</a>.</p>

<h3 id="a-detour-to-perl">A detour to Perl</h3>

<p>The initial post in that thread was replacing tabs like this:</p>

<figure class="highlight"><pre><code class="language-perl" data-lang="perl"><span class="c1">#!/usr/bin/perl -pi</span>
<span class="sr">s/\t/    /</span><span class="p">;</span></code></pre></figure>

<p>That code misses one point: if there is any string before a tab, it will simply 
add four spaces after that string. However, that is not how tabs work. What 
should happen is that enough spaces should be added, until the length of the 
initial string plus the newly added spaces, add up to the next multiple of 
four. So, the suggested substitution in Perl becomes:</p>

<figure class="highlight"><pre><code class="language-perl" data-lang="perl"><span class="sr">s/(.*?)\t/$1.(' ' x (4-length($1)%4))/ge</span><span class="p">;</span></code></pre></figure>

<p>There are two flags used there: <code class="highlighter-rouge">g</code> applies the substitution for all matches of 
the left pattern (<code class="highlighter-rouge">(.*?)\t</code>). Without that flag, only the first match would be 
processed. The second flag, <code class="highlighter-rouge">e</code>, forces the substitute 
(<code class="highlighter-rouge">$1.(' ' x (4-length($1)%4))</code>) to be evaluated as an expression itself. 
Without this flag, the second part would be handled as a raw string.</p>

<h3 id="back-to-python">Back to Python</h3>

<p>Here is the Python code, cleaned up a little:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">re</span>
<span class="n">DEFAULT_TAB_LENGTH</span> <span class="o">=</span> <span class="mi">4</span>

<span class="n">_detab_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="s">r'(.*?)</span><span class="err">\</span><span class="s">t'</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_detab_sub</span><span class="p">(</span><span class="n">match</span><span class="p">):</span>
    <span class="n">g1</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">g1</span> <span class="o">+</span> <span class="p">(</span><span class="s">' '</span> <span class="o">*</span> <span class="p">(</span><span class="n">DEFAULT_TAB_LENGTH</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">g1</span><span class="p">)</span> <span class="o">%</span> <span class="n">DEFAULT_TAB_LENGTH</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_detab</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="k">if</span> <span class="s">'</span><span class="se">\t</span><span class="s">'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">text</span>
    <span class="k">return</span> <span class="n">_detab_re</span><span class="o">.</span><span class="n">subn</span><span class="p">(</span><span class="n">_detab_sub</span><span class="p">,</span> <span class="n">text</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></code></pre></figure>

<h4 id="explanation">Explanation</h4>

<p>The <code class="highlighter-rouge">_detab_re</code> object is a compiled Regular Expression object, built with the 
same pattern as the one used in the Perl example, and with the multiline flag 
enabled (<code class="highlighter-rouge">re.M</code>). You can test this out at <a href="http://regexr.com/3c8o7" title="Tabs to spaces regular expression">RegExr</a>. The <code class="highlighter-rouge">subn()</code> 
method of that object is called in the last line. It takes two parameters: the 
<code class="highlighter-rouge">_detab_sub()</code> function, and the text to be processed. For every match of the 
pattern, <code class="highlighter-rouge">_detab_sub()</code> is called, and the matched string is passed to the 
<code class="highlighter-rouge">_detab_sub()</code> function for processing. Finally, <code class="highlighter-rouge">subn()</code> returns a tuple with 
the text with the pattern substituted, and the number of substitutions that
happened. From that result, only the text is kept, with that <code class="highlighter-rouge">subn()[0]</code>, 
which seems a bit redundant, since the <code class="highlighter-rouge">sub()</code> method would do that without 
requiring the <code class="highlighter-rouge">[0]</code> subscription.</p>

<h4 id="no-regular-expressions-please">No regular expressions please</h4>

<p>Here is a Python snippet that does the same thing as the previous one, without 
using regular expressions:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">DEFAULT_TAB_LENGTH</span> <span class="o">=</span> <span class="mi">4</span>

<span class="k">def</span> <span class="nf">_detab_no_re_sub</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
    <span class="k">if</span> <span class="s">'</span><span class="se">\t</span><span class="s">'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">l</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">g1</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'</span><span class="se">\t</span><span class="s">'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">g1</span>
        <span class="n">output</span> <span class="o">+=</span> <span class="p">(</span><span class="s">' '</span> <span class="o">*</span> <span class="p">(</span><span class="n">DEFAULT_TAB_LENGTH</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">g1</span><span class="p">)</span> <span class="o">%</span> <span class="n">DEFAULT_TAB_LENGTH</span><span class="p">))</span>
        <span class="n">output</span> <span class="o">+=</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'</span><span class="se">\t</span><span class="s">'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">_detab_no_re_sub</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_detab_no_re</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="s">'</span><span class="se">\t</span><span class="s">'</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">text</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_detab_no_re_sub</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
    <span class="k">return</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">)</span></code></pre></figure>

<h4 id="performance">Performance</h4>

<p>In the <a href="/blog/2015/11/07/regex-in-python-markdown2-pt1.html" title="Regular expressions in python-markdown2 (part 1)">previous article on regular expressions in python-markdown2</a> I 
dismissed the difference between a substring substitution with <code class="highlighter-rouge">re.sub()</code> 
versus <code class="highlighter-rouge">str.replace()</code> as being negligible, but in this case it seems that it 
is more substantial. This simple example already indicates some difference:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">text</span> <span class="o">=</span> <span class="s">'''
We are
        NOT
in Kansas
        any more!
'''</span>

<span class="o">%</span><span class="n">timeit</span> <span class="n">_detab</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="mi">100000</span> <span class="n">loops</span><span class="p">,</span> <span class="n">best</span> <span class="n">of</span> <span class="mi">3</span><span class="p">:</span> <span class="mf">6.14</span> <span class="n">us</span> <span class="n">per</span> <span class="n">loop</span>

<span class="o">%</span><span class="n">timeit</span> <span class="n">_detab_no_re</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="mi">100000</span> <span class="n">loops</span><span class="p">,</span> <span class="n">best</span> <span class="n">of</span> <span class="mi">3</span><span class="p">:</span> <span class="mf">3.82</span> <span class="n">us</span> <span class="n">per</span> <span class="n">loop</span></code></pre></figure>

<p>To test a larger example, I took <a href="/static/etc/bzip2.c" title="bzip2.c Source Code">this version of the source code of bzip2</a>
which uses three spaces for indentation, and made some substitutions in it:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Change some spaces in the beginning of lines with tabs:</span>
sed -i <span class="s1">'s/^   /\t/'</span> bzip2.c 
sed -i <span class="s1">'s/^\t   /\t\t/'</span> bzip2.c
<span class="c"># Lines with tabs:</span>
grep -c <span class="s1">'\t'</span> bzip2.c 
3032
<span class="c"># Total lines:</span>
wc -l bzip2.c 
6998 bzip2.c</code></pre></figure>

<p>Timing test with this file:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">text</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="s">'bzip2.c'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="o">%</span><span class="n">timeit</span> <span class="n">_detab</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="mi">10</span> <span class="n">loops</span><span class="p">,</span> <span class="n">best</span> <span class="n">of</span> <span class="mi">3</span><span class="p">:</span> <span class="mf">90.1</span> <span class="n">ms</span> <span class="n">per</span> <span class="n">loop</span>

<span class="o">%</span><span class="n">timeit</span> <span class="n">_detab_no_re</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="mi">100</span> <span class="n">loops</span><span class="p">,</span> <span class="n">best</span> <span class="n">of</span> <span class="mi">3</span><span class="p">:</span> <span class="mi">11</span> <span class="n">ms</span> <span class="n">per</span> <span class="n">loop</span></code></pre></figure>

<p>That is significant difference, not using regular expressions makes the 
process about 8 times faster.</p>

<h3 id="conclusion">Conclusion</h3>

<p>Based on this article, and on the previous one, I would prefer to use other 
methods for substring replacements than regular expressions.</p>

<!-- Links -->

  </section>

  <footer id="post-footer">
  
    Last modified: <span itemprop="dateModified">2016-05-15</span>
  
  
    &ndash; License: <a href="https://creativecommons.org/licenses/by-sa/4.0/" itemprop="license" title="Creative Commons Attribution-ShareAlike 4.0 International">CC-BY-SA-4.0</a>
  
  </footer>

</article>

  </div>

  <footer id="site-footer" class="footer-distributed">
  <div class="container">
    <div class="footer-right">
      <a href="/feed.xml" title="Marios Zindilis RSS Feed">
        <i class="fa fa-rss" aria-hidden="true"></i><span class="sr-only">Marios Zindilis RSS Feed</span></a>
      <a href="https://www.facebook.com/zindilis" title="Marios Zindilis Facebook">
        <i class="fa fa-facebook" aria-hidden="true"></i><span class="sr-only">Marios Zindilis Facebook</span></a>
      <a href="https://twitter.com/MariosZindilis" title="Marios Zindilis Twitter">
        <i class="fa fa-twitter" aria-hidden="true"></i><span class="sr-only">Marios Zindilis Twitter</span></a>
      <a href="https://www.linkedin.com/in/zindilis" title="Marios Zindilis LinkedIn Profile">
        <i class="fa fa-linkedin" aria-hidden="true"></i><span class="sr-only">Marios Zindilis LinkedIn Profile</span></a>
      <a href="https://github.com/marios-zindilis" title="Marios Zindilis GitHub Page">
        <i class="fa fa-github" aria-hidden="true"></i><span class="sr-only">Marios Zindilis GitHub Page</span></a>
    </div>

    <div class="footer-left">
      <p class="footer-links">
        <a href="/">Home</a> · 
        <a href="/docs/">Docs</a> ·
        <a href="/projects/">Projects</a> ·
        <a href="/about/">About</a>
      </p>
      <p>Marios Zindilis</p>
    </div>
  </div>
</footer>

      <script
      src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"
      integrity="sha384-3ceskX3iaEnIogmQchP8opvBy3Mi7Ce34nWjpBIwVTHfGYWQS9jwHDVRnpKKHJg7"
      crossorigin="anonymous"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.3.7/js/tether.min.js"
      integrity="sha384-XTs3FgkjiBgo8qjEjBk0tGmf3wPrWtA6coPfQDfFEY8AnYJwjalXCiosYRBIBZX8"
      crossorigin="anonymous"></script>
    <script
      src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/js/bootstrap.min.js"
      integrity="sha384-BLiI7JTZm+JWlgKa0M0kGRpJbF2J8q+qreVrKBC47e3K6BW78kGLrCkeRX6I9RoK"
      crossorigin="anonymous"></script>
    <script type="text/javascript">
      // set padding-bottom of body to height of footer.site-footer:
      document.body.style.marginBottom = document.getElementById("site-footer").clientHeight + "px";
      // http://stackoverflow.com/a/14570614
      var observeDOM = (function(){
        var MutationObserver = window.MutationObserver || window.WebKitMutationObserver,
          eventListenerSupported = window.addEventListener;

        return function(obj, callback){
          if( MutationObserver ){
          // define a new observer
            var obs = new MutationObserver(function(mutations, observer){
              if( mutations[0].addedNodes.length || mutations[0].removedNodes.length )
              callback();
            });
            // have the observer observe foo for changes in children
            obs.observe( obj, { childList:true, subtree:true });
          }
          else if( eventListenerSupported ){
            obj.addEventListener('DOMNodeInserted', callback, false);
            obj.addEventListener('DOMNodeRemoved', callback, false);
          }
        }
      })();
      observeDOM(document.getElementById('site-footer') ,function(){
        document.body.style.marginBottom = document.getElementById("site-footer").clientHeight + "px";
      });
    </script>


  </body>
</html>
