<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Marios Zindilis - Regular expressions in python-markdown2 (part 1)</title>
  <meta name="description" content="Study of the regular expressions used in python-markdown2 library">
  <link
    rel="stylesheet"
    href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css"
    integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M"
    crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="/static/css/zindilis.com.css">
  <link rel="canonical" href="https://zindilis.com/blog/2015/11/07/regex-in-python-markdown2-pt1.html">
  <link rel="alternate" type="application/rss+xml" title="Marios Zindilis" href="https://zindilis.com/feed.xml">
  
  <meta property="og:title" content="Regular expressions in python-markdown2 (part 1)">


  <meta property="og:type" content="article">

  <meta property="og:article:published_time" content="2015-11-07">


  <meta property="og:article:modified_time" content="2016-05-08">




  <meta property="og:description" content="Study of the regular expressions used in python-markdown2 library">


</head>


<body>
  <header class="mb-4">
  <nav class="navbar navbar-expand-md navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="/">Marios Zindilis</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-link-items" aria-controls="navbar-link-items" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbar-link-items">
        <div class="navbar-nav ml-auto">
          <a class="nav-item nav-link" style="color:white" href="/docs/">Docs</a>
          <a class="nav-item nav-link" style="color:white" href="/projects/">Projects</a>
          <a class="nav-item nav-link" style="color:white" href="/about/">About</a>
        </div>
      </div>
    </div>
  </nav>
</header>


  <div class="container">
        <article itemscope itemtype="http://schema.org/BlogPosting">

  <header>
    <h1 itemprop="name headline">Regular expressions in python-markdown2 (part 1)</h1>
    <p class="post-meta">
      <time datetime="2015-11-07T00:00:00+00:00" itemprop="datePublished">2015-11-07</time>
      • <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Marios Zindilis</span></span>
    </p>
  </header>

  <section itemprop="articleBody">
    <p class="lead">This article is a look into the performance of one of the
regular expressions used in the 
<a href="https://github.com/trentm/python-markdown2" 
title="python-markdown2 on Github"> python-markdown2</a> Python module for 
converting Markdown syntax to HTML. It was initially written for pure fun, and 
in celebration of its own pointlessness, but eventually the changes proposed
here made it upstream in
<a href="https://github.com/trentm/python-markdown2/pull/204">pull request 
204</a>.</p>

<h2>Standardize line endings</h2>

<p>This regular expression appears very early in the conversion process:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">"</span><span class="se">\r\n</span><span class="s">|</span><span class="se">\r</span><span class="s">"</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span></code></pre></figure>

<p>Its use is fairly obvious: it changes all single carriage returns (<code>\r</code>) and 
all carriage returns followed by a newline (<code>\r\n</code>) to single newlines (<code>\n</code>).
The same effect can be achieved in Python with two <code>str.replace()</code> statements 
and in fact that would be much faster. The following example uses <code>timeit</code>, 
which comes with the IPython shell:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">%</span><span class="n">timeit</span> <span class="s">'Apples</span><span class="se">\r\n</span><span class="s">Oranges</span><span class="se">\r\n</span><span class="s">Kiwis</span><span class="se">\r</span><span class="s">Grapes</span><span class="se">\r</span><span class="s">'</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'</span><span class="se">\r\n</span><span class="s">'</span><span class="p">,</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
<span class="mi">1000000</span> <span class="n">loops</span><span class="p">,</span> <span class="n">best</span> <span class="n">of</span> <span class="mi">3</span><span class="p">:</span> <span class="mi">270</span> <span class="n">ns</span> <span class="n">per</span> <span class="n">loop</span>

<span class="o">%</span><span class="n">timeit</span> <span class="s">'Apples</span><span class="se">\r\n</span><span class="s">Oranges</span><span class="se">\r\n</span><span class="s">Kiwis</span><span class="se">\r</span><span class="s">Grapes</span><span class="se">\r</span><span class="s">'</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'</span><span class="se">\r</span><span class="s">'</span><span class="p">,</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
<span class="mi">1000000</span> <span class="n">loops</span><span class="p">,</span> <span class="n">best</span> <span class="n">of</span> <span class="mi">3</span><span class="p">:</span> <span class="mi">195</span> <span class="n">ns</span> <span class="n">per</span> <span class="n">loop</span>

<span class="o">%</span><span class="n">timeit</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r'</span><span class="err">\</span><span class="s">r</span><span class="err">\</span><span class="s">n|</span><span class="err">\</span><span class="s">r'</span><span class="p">,</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">,</span> <span class="s">'Apples</span><span class="se">\r\n</span><span class="s">Oranges</span><span class="se">\r\n</span><span class="s">Kiwis</span><span class="se">\r</span><span class="s">Grapes</span><span class="se">\r</span><span class="s">'</span><span class="p">)</span>
<span class="mi">100000</span> <span class="n">loops</span><span class="p">,</span> <span class="n">best</span> <span class="n">of</span> <span class="mi">3</span><span class="p">:</span> <span class="mf">2.31</span> <span class="n">us</span> <span class="n">per</span> <span class="n">loop</span></code></pre></figure>

<p>So the two runs of <code>str.replace()</code> add up to 465 nanoseconds, whereas one run 
of <code>re.sub()</code> takes 2.31 microseconds, that is 2310 nanoseconds, or about 
<strong>five times slower</strong>. </p>

<p>The question is: <em>Does it matter?</em> Well, my copy of 
<em>The Hitch Hiker&#39;s Guide to the Galaxy</em> that includes all five books in the 
series, is 776 pages long, and each full page has 42 lines (yes, I counted 
twice, and now I am wondering if it was done on purpose). Following up on the 
previous calculations, if you had to convert that book from Markdown to HTML, 
(about 32592 lines), it would take you a whole 0.02 seconds to do that with 
<code>re.sub()</code>, or about 0.004 seconds to do that with <code>str.replace()</code>. 
Therefore, the answer to my previous question: <em>Does it matter?</em> is 42.</p>

<p>Now the question becomes: <em>Does it *</em>really** matter?* Well, if you had to 
convert all 30 million paperback books that Amazon has for sale (number found 
through a search on amazon.com), and assuming each book is as healthy in size 
as <abbr title="The Hitch Hicker's Guide To The Galaxy">THHGTTG</abbr>, then it 
would take you a week to do that with <code>re.sub()</code>, but only a day and a 
half to do it with <code>str.replace()</code>. Thus, for the Python developer out there 
who is pondering on converting 30 million books from Markdown to HTML, the 
answer is: Go with <code>str.replace()</code>. For the rest of us it&#39;s still 42.</p>

  </section>

  <footer id="post-footer">
  
    First Published: <time datetime="2015-11-07T00:00:00+00:00" itemprop="datePublished">2015-11-07</time>
  
  
    &middot; Last modified: <span itemprop="dateModified">2016-05-08</span>
  
  
    &middot; License: <a href="https://creativecommons.org/licenses/by-sa/4.0/" itemprop="license" title="Creative Commons Attribution-ShareAlike 4.0 International">CC-BY-SA-4.0</a>
  
  </footer>

</article>

  </div>

  <footer id="site-footer" class="footer-distributed">
  <div class="container">
    <div class="footer-right">
      <a href="/feed.xml" title="Marios Zindilis RSS Feed">
        <i class="fa fa-rss" aria-hidden="true"></i><span class="sr-only">Marios Zindilis RSS Feed</span></a>
      <a href="https://www.linkedin.com/in/zindilis" title="Marios Zindilis LinkedIn Profile">
        <i class="fa fa-linkedin" aria-hidden="true"></i><span class="sr-only">Marios Zindilis LinkedIn Profile</span></a>
      <a href="https://github.com/marios-zindilis" title="Marios Zindilis GitHub Page">
        <i class="fa fa-github" aria-hidden="true"></i><span class="sr-only">Marios Zindilis GitHub Page</span></a>
    </div>

    <div class="footer-left">
      <p class="footer-links">
        <a href="/">Home</a> · 
        <a href="/docs/">Docs</a> ·
        <a href="/projects/">Projects</a> ·
        <a href="/about/">About</a>
      </p>
      <p>Marios Zindilis</p>
    </div>
  </div>
</footer>

  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>
    <script type="text/javascript">
      // set padding-bottom of body to height of footer.site-footer:
      document.body.style.marginBottom = document.getElementById("site-footer").clientHeight + "px";
      // http://stackoverflow.com/a/14570614
      var observeDOM = (function(){
        var MutationObserver = window.MutationObserver || window.WebKitMutationObserver,
          eventListenerSupported = window.addEventListener;

        return function(obj, callback){
          if( MutationObserver ){
          // define a new observer
            var obs = new MutationObserver(function(mutations, observer){
              if( mutations[0].addedNodes.length || mutations[0].removedNodes.length )
              callback();
            });
            // have the observer observe foo for changes in children
            obs.observe( obj, { childList:true, subtree:true });
          }
          else if( eventListenerSupported ){
            obj.addEventListener('DOMNodeInserted', callback, false);
            obj.addEventListener('DOMNodeRemoved', callback, false);
          }
        }
      })();
      observeDOM(document.getElementById('site-footer') ,function(){
        document.body.style.marginBottom = document.getElementById("site-footer").clientHeight + "px";
      });
    </script>


  </body>
</html>
